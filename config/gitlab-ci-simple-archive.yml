# GitLab CI/CD Pipeline for React Monorepo
# ìµœì‹  íŒ¨í„´: Turborepo Remote Caching + Docker BuildKit + ê°„ì†Œí™”ëœ ì•„ì¹´ì´ë¹™

# ì „ì—­ ë³€ìˆ˜ ì •ì˜
variables:
  # Docker ê´€ë ¨
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  
  # Node.js ë²„ì „ ê³ ì • (LTS ê¶Œì¥)
  NODE_VERSION: "20"
  
  # Turborepo ì›ê²© ìºì‹± (ì„ íƒì‚¬í•­)
  TURBO_TOKEN: $TURBO_TOKEN
  TURBO_TEAM: $TURBO_TEAM
  
  # ë°°í¬ ëŒ€ìƒ ì„œë²„
  DEV_SERVER_HOST: $DEV_SERVER_HOST
  DEV_SERVER_USER: $DEV_SERVER_USER

# ìºì‹œ ì „ëµ: package-lock.json ê¸°ë°˜ + Turborepo ìºì‹œ
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .turbo/
    - apps/*/node_modules/
    - packages/*/node_modules/

# ìŠ¤í…Œì´ì§€ ì •ì˜
stages:
  - prepare      # ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì¤€ë¹„
  - validate     # ë¦°íŠ¸, íƒ€ì… ì²´í¬, í…ŒìŠ¤íŠ¸
  - build        # í”„ë¡œë•ì…˜ ë¹Œë“œ
  - package      # Docker ì´ë¯¸ì§€ ìƒì„±
  - deploy       # ê°œë°œ ì„œë²„ ë°°í¬
  - archive      # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì•„ì¹´ì´ë¹™

# =====================================
# Stage 1: ì¤€ë¹„
# =====================================
install_dependencies:
  stage: prepare
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "ğŸ“¦ Installing dependencies..."
    - npm ci --prefer-offline --no-audit
    - echo "âœ… Dependencies installed"
  artifacts:
    paths:
      - node_modules/
      - apps/*/node_modules/
      - packages/*/node_modules/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# =====================================
# Stage 2: ê²€ì¦ (ë³‘ë ¬ ì‹¤í–‰)
# =====================================
lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - echo "ğŸ” Running ESLint..."
    - npx turbo run lint
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop

type_check:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - echo "ğŸ” Type checking..."
    - npx turbo run type-check
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop

test:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - echo "ğŸ§ª Running tests..."
    - npx turbo run test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

# =====================================
# Stage 3: ë¹Œë“œ (ë³‘ë ¬ ì‹¤í–‰)
# =====================================
build_all_apps:
  stage: build
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies", "lint", "type_check", "test"]
  script:
    - echo "ğŸ—ï¸ Building all apps with Turborepo..."
    - npx turbo run build --filter='./apps/*'
  artifacts:
    paths:
      - apps/*/dist/
    expire_in: 1 day
  only:
    - main
    - develop

# =====================================
# Stage 4: Docker ì´ë¯¸ì§€ ìƒì„±
# =====================================
docker_build:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  needs: ["build_all_apps"]
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ğŸ³ Building Docker images..."
    - |
      for app in apps/*/; do
        app_name=$(basename "$app")
        echo "Building $app_name..."
        docker build \
          --build-arg APP_NAME=$app_name \
          --cache-from $CI_REGISTRY_IMAGE/$app_name:latest \
          --tag $CI_REGISTRY_IMAGE/$app_name:$CI_COMMIT_SHA \
          --tag $CI_REGISTRY_IMAGE/$app_name:latest \
          --file docker/Dockerfile.app \
          .
        docker push $CI_REGISTRY_IMAGE/$app_name:$CI_COMMIT_SHA
        docker push $CI_REGISTRY_IMAGE/$app_name:latest
      done
  only:
    - main
    - develop

# =====================================
# Stage 5: ê°œë°œ ì„œë²„ ë°°í¬
# =====================================
deploy_to_dev:
  stage: deploy
  image: alpine:latest
  needs: ["docker_build"]
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEV_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ Deploying to development server..."
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << 'ENDSSH'
        cd /opt/my-monorepo
        docker compose pull
        docker compose up -d --remove-orphans
        docker image prune -af --filter "until=24h"
      ENDSSH
    - echo "âœ… Deployment completed"
  environment:
    name: development
    url: https://dev.yourcompany.com
  only:
    - develop

# =====================================
# Stage 6: ì•„í‹°íŒ©íŠ¸ ì•„ì¹´ì´ë¹™ (ê°„ì†Œí™”)
# =====================================
archive_build:
  stage: archive
  image: alpine:latest
  needs: ["build_all_apps"]
  before_script:
    - apk add --no-cache git curl
  script:
    - echo "ğŸ“¦ Archiving commit information..."
    
    # ì•„í‹°íŒ©íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
    - mkdir -p build-artifacts/$CI_COMMIT_REF_NAME
    
    # =====================================
    # ë°©ë²• 1: ì»¤ë°‹ URLë§Œ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥ (ê°€ì¥ ê°„ë‹¨)
    # =====================================
    - |
      cat > build-artifacts/$CI_COMMIT_REF_NAME/commit-${CI_PIPELINE_ID}.txt << EOF
      ===============================================
      Build Artifact - Pipeline #${CI_PIPELINE_ID}
      ===============================================
      
      ë¸Œëœì¹˜: ${CI_COMMIT_REF_NAME}
      ì»¤ë°‹ SHA: ${CI_COMMIT_SHA}
      ì»¤ë°‹ ì‘ì„±ì: $(git log -1 --pretty=format:'%an <%ae>')
      ì»¤ë°‹ ë‚ ì§œ: $(git log -1 --pretty=format:'%ci')
      ì»¤ë°‹ ë©”ì‹œì§€: $(git log -1 --pretty=format:'%s')
      
      ===============================================
      GitLab ì»¤ë°‹ í˜ì´ì§€ (ìš°í´ë¦­ > ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥)
      ===============================================
      ${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}
      
      ===============================================
      ë¹Œë“œëœ ì•± ëª©ë¡
      ===============================================
      EOF
    
    # ë¹Œë“œëœ ì•± ëª©ë¡ ì¶”ê°€
    - |
      for app in apps/*/; do
        app_name=$(basename "$app")
        echo "- $app_name" >> build-artifacts/$CI_COMMIT_REF_NAME/commit-${CI_PIPELINE_ID}.txt
      done
    
    - |
      cat >> build-artifacts/$CI_COMMIT_REF_NAME/commit-${CI_PIPELINE_ID}.txt << EOF
      
      ===============================================
      ì‚¬ìš© ë°©ë²•
      ===============================================
      1. ìœ„ì˜ GitLab ì»¤ë°‹ í˜ì´ì§€ URLì„ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°
      2. ë§ˆìš°ìŠ¤ ìš°í´ë¦­ > "ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥" í´ë¦­
      3. HTML íŒŒì¼ë¡œ ì €ì¥ë¨ (GitLab ê¸°ë³¸ ìŠ¤íƒ€ì¼ í¬í•¨)
      
      ë˜ëŠ” wgetìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ:
      wget -O commit-${CI_COMMIT_SHA}.html "${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}"
      
      ===============================================
      ë¹Œë“œ ì •ë³´
      ===============================================
      Docker ì´ë¯¸ì§€: ${CI_REGISTRY_IMAGE}/*:${CI_COMMIT_SHA}
      íŒŒì´í”„ë¼ì¸ URL: ${CI_PIPELINE_URL}
      ìƒì„± ì‹œê°„: $(date)
      EOF
    
    - echo "âœ… Commit information saved to build-artifacts/$CI_COMMIT_REF_NAME/commit-${CI_PIPELINE_ID}.txt"
    
    # =====================================
    # ë°©ë²• 2: wgetìœ¼ë¡œ GitLab ì»¤ë°‹ í˜ì´ì§€ë¥¼ HTMLë¡œ ìë™ ì €ì¥ (ì„ íƒì‚¬í•­)
    # =====================================
    - |
      if [ -n "$GITLAB_TOKEN" ]; then
        echo "ğŸ“¥ Downloading GitLab commit page as HTML..."
        
        # íŒŒì¼ëª…: YYYYMMDD-HHMM-ì»¤ë°‹ë©”ì‹œì§€-í•´ì‹œ.html
        COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y%m%d-%H%M' ${CI_COMMIT_SHA})
        COMMIT_MSG=$(git log -1 --format=%s ${CI_COMMIT_SHA} | sed 's/[^a-zA-Z0-9ê°€-í£]/-/g' | cut -c1-50)
        COMMIT_SHORT=$(echo ${CI_COMMIT_SHA} | cut -c1-8)
        FILENAME="${COMMIT_DATE}-${COMMIT_MSG}-${COMMIT_SHORT}.html"
        
        echo "Saving as: $FILENAME"
        
        wget --header="PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
             --header="Accept: text/html" \
             --timeout=30 \
             --tries=3 \
             -O "build-artifacts/$CI_COMMIT_REF_NAME/${FILENAME}" \
             "${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}" \
             && echo "âœ… HTML saved: ${FILENAME}" \
             || echo "âš ï¸ Failed to download HTML (ì¸ì¦ í•„ìš” ë˜ëŠ” ê¶Œí•œ ë¶€ì¡±)"
      else
        echo "â„¹ï¸ GITLAB_TOKEN not set, skipping automatic HTML download"
        echo "   ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ë ¤ë©´ ìœ„ì˜ URLì„ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê³  'ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥'í•˜ì„¸ìš”"
      fi
    
    # =====================================
    # í´ë¼ìš°ë“œ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)
    # =====================================
    - |
      if [ -n "$RCLONE_CONFIG" ]; then
        echo "â˜ï¸ Uploading to cloud storage..."
        echo "$RCLONE_CONFIG" > ~/.rclone.conf
        apk add --no-cache rclone
        rclone copy build-artifacts/ remote:build-artifacts/ -v \
          || echo "âš ï¸ Cloud upload failed, but artifacts are saved in GitLab"
      else
        echo "â„¹ï¸ RCLONE_CONFIG not set, skipping cloud upload"
      fi
  
  artifacts:
    paths:
      - build-artifacts/
    expire_in: 90 days
  only:
    - main
    - develop
    - merge_requests

# =====================================
# ì„ íƒ: ìˆ˜ë™ HTML ë‹¤ìš´ë¡œë“œ Job
# =====================================
download_commit_html:
  stage: archive
  image: alpine:latest
  needs: ["build_all_apps"]
  before_script:
    - apk add --no-cache curl git
  script:
    - echo "ğŸ“¥ Downloading GitLab commit page..."
    - mkdir -p commit-htmls
    - |
      # GITLAB_TOKENì´ ìˆìœ¼ë©´ ìë™ ë‹¤ìš´ë¡œë“œ
      if [ -n "$GITLAB_TOKEN" ]; then
        # íŒŒì¼ëª…: YYYYMMDD-HHMM-ì»¤ë°‹ë©”ì‹œì§€-í•´ì‹œ.html
        COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y%m%d-%H%M' ${CI_COMMIT_SHA})
        COMMIT_MSG=$(git log -1 --format=%s ${CI_COMMIT_SHA} | sed 's/[^a-zA-Z0-9ê°€-í£]/-/g' | cut -c1-50)
        COMMIT_SHORT=$(echo ${CI_COMMIT_SHA} | cut -c1-8)
        FILENAME="${COMMIT_DATE}-${COMMIT_MSG}-${COMMIT_SHORT}.html"
        
        echo "Saving as: $FILENAME"
        
        curl -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
             -H "Accept: text/html" \
             --connect-timeout 30 \
             --max-time 60 \
             -o "commit-htmls/${FILENAME}" \
             "${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}" \
             && echo "âœ… HTML downloaded: ${FILENAME}" \
             || echo "âš ï¸ Download failed"
      else
        echo "âš ï¸ GITLAB_TOKEN not set"
        echo "ìˆ˜ë™ ë‹¤ìš´ë¡œë“œ ë°©ë²•:"
        echo "1. ë¸Œë¼ìš°ì €ì—ì„œ ë‹¤ìŒ URL ì—´ê¸°:"
        echo "   ${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}"
        echo "2. ìš°í´ë¦­ > 'ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥'"
      fi
  artifacts:
    paths:
      - commit-htmls/
    expire_in: 90 days
  when: manual  # ìˆ˜ë™ ì‹¤í–‰
  only:
    - main
    - develop
