# GitLab CI/CD Pipeline for React Monorepo
# ÏµúÏã† Ìå®ÌÑ¥: Turborepo Remote Caching + Docker BuildKit + Î≥ëÎ†¨ Job

# Ï†ÑÏó≠ Î≥ÄÏàò Ï†ïÏùò
variables:
  # Docker Í¥ÄÎ†®
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  
  # Node.js Î≤ÑÏ†Ñ Í≥†Ï†ï (LTS Í∂åÏû•)
  NODE_VERSION: "20"
  
  # Turborepo ÏõêÍ≤© Ï∫êÏã± (ÏÑ†ÌÉùÏÇ¨Ìï≠ - Vercel Remote Cache ÎòêÎäî ÏûêÏ≤¥ S3)
  TURBO_TOKEN: $TURBO_TOKEN
  TURBO_TEAM: $TURBO_TEAM
  
  # Î∞∞Ìè¨ ÎåÄÏÉÅ ÏÑúÎ≤Ñ
  DEV_SERVER_HOST: $DEV_SERVER_HOST
  DEV_SERVER_USER: $DEV_SERVER_USER
  
  # ÏïÑÌã∞Ìå©Ìä∏ Ï†ÄÏû• Í≤ΩÎ°ú
  ARTIFACT_BASE_PATH: "build-artifacts"

# Ï∫êÏãú Ï†ÑÎûµ: package-lock.json Í∏∞Î∞ò + Turborepo Ï∫êÏãú
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .turbo/
    - apps/*/node_modules/
    - packages/*/node_modules/

# Ïä§ÌÖåÏù¥ÏßÄ Ï†ïÏùò: ÏàúÏ∞®Ï†Å ÌååÏù¥ÌîÑÎùºÏù∏
stages:
  - prepare      # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò Î∞è Ï§ÄÎπÑ
  - validate     # Î¶∞Ìä∏, ÌÉÄÏûÖ Ï≤¥ÌÅ¨, ÌÖåÏä§Ìä∏
  - build        # ÌîÑÎ°úÎçïÏÖò ÎπåÎìú
  - package      # Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
  - deploy       # Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨
  - archive      # ÎπåÎìú ÏïÑÌã∞Ìå©Ìä∏ ÏïÑÏπ¥Ïù¥Îπô

# =====================================
# Stage 1: Ï§ÄÎπÑ
# =====================================
install_dependencies:
  stage: prepare
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üì¶ Installing dependencies with npm ci..."
    - npm ci --prefer-offline --no-audit
    - echo "‚úÖ Dependencies installed"
  artifacts:
    paths:
      - node_modules/
      - apps/*/node_modules/
      - packages/*/node_modules/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# =====================================
# Stage 2: Í≤ÄÏ¶ù (Î≥ëÎ†¨ Ïã§Ìñâ)
# =====================================
lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - echo "üîç Running ESLint across all workspaces..."
    - npx turbo run lint
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop

type_check:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - echo "üîç Type checking with TypeScript..."
    - npx turbo run type-check
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop

test:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - echo "üß™ Running tests with coverage..."
    - npx turbo run test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

# =====================================
# Stage 3: ÎπåÎìú (Î≥ëÎ†¨ Ïã§Ìñâ)
# =====================================
# Î≥ÄÍ≤ΩÎêú Ïï±Îßå ÎπåÎìúÌïòÎèÑÎ°ù ÎèôÏ†Å Ï≤òÎ¶¨ (TurborepoÏùò --filter ÌôúÏö©)
build_all_apps:
  stage: build
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies", "lint", "type_check", "test"]
  script:
    - echo "üèóÔ∏è Building all apps with Turborepo..."
    # TurborepoÍ∞Ä Î≥ÄÍ≤Ω Í∞êÏßÄ Î∞è Ï∫êÏã± Ï≤òÎ¶¨
    - npx turbo run build --filter='./apps/*'
  artifacts:
    paths:
      - apps/*/dist/
      - apps/*/.next/
    expire_in: 1 day
  only:
    - main
    - develop

# Í∞úÎ≥Ñ Ïï± ÎπåÎìú ÏòàÏãú (ÌäπÏ†ï Î∏åÎûúÏπòÎÇò MRÏóêÏÑúÎßå)
build_feature_a:
  stage: build
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies", "lint", "type_check", "test"]
  script:
    - echo "üèóÔ∏è Building feature-a only..."
    - npx turbo run build --filter='feature-a'
  artifacts:
    paths:
      - apps/feature-a/dist/
      - apps/feature-a/.next/
    expire_in: 1 day
  only:
    changes:
      - apps/feature-a/**/*
      - packages/**/*
  except:
    - main

# =====================================
# Stage 4: Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
# =====================================
docker_build:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  needs: ["build_all_apps"]
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "üê≥ Building Docker images with BuildKit..."
    # Î©ÄÌã∞Ïä§ÌÖåÏù¥ÏßÄ ÎπåÎìúÎ°ú ÏµúÏ†ÅÌôîÎêú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
    - |
      for app in apps/*/; do
        app_name=$(basename "$app")
        echo "Building $app_name..."
        docker build \
          --build-arg APP_NAME=$app_name \
          --cache-from $CI_REGISTRY_IMAGE/$app_name:latest \
          --tag $CI_REGISTRY_IMAGE/$app_name:$CI_COMMIT_SHA \
          --tag $CI_REGISTRY_IMAGE/$app_name:latest \
          --file docker/Dockerfile.app \
          .
        docker push $CI_REGISTRY_IMAGE/$app_name:$CI_COMMIT_SHA
        docker push $CI_REGISTRY_IMAGE/$app_name:latest
      done
  only:
    - main
    - develop

# =====================================
# Stage 5: Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨
# =====================================
deploy_to_dev:
  stage: deploy
  image: alpine:latest
  needs: ["docker_build"]
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEV_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "üöÄ Deploying to development server..."
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << 'ENDSSH'
        cd /opt/my-monorepo
        # Docker ComposeÎ°ú ÏÑúÎπÑÏä§ ÏóÖÎç∞Ïù¥Ìä∏
        docker compose pull
        docker compose up -d --remove-orphans
        # Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
        docker image prune -af --filter "until=24h"
      ENDSSH
    - echo "‚úÖ Deployment completed"
  environment:
    name: development
    url: https://dev.yourcompany.com
  only:
    - develop

deploy_to_prod:
  stage: deploy
  image: alpine:latest
  needs: ["docker_build"]
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEV_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "üöÄ Deploying to production server..."
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << 'ENDSSH'
        cd /opt/my-monorepo-prod
        docker compose pull
        docker compose up -d --remove-orphans
        docker image prune -af --filter "until=72h"
      ENDSSH
    - echo "‚úÖ Production deployment completed"
  environment:
    name: production
    url: https://yourcompany.com
  when: manual  # ÏàòÎèô ÏäπÏù∏ ÌïÑÏöî
  only:
    - main

# =====================================
# Stage 6: ÏïÑÌã∞Ìå©Ìä∏ ÏïÑÏπ¥Ïù¥Îπô
# =====================================
archive_build:
  stage: archive
  image: node:${NODE_VERSION}-alpine
  needs: ["build_all_apps"]
  before_script:
    - apk add --no-cache git curl
  script:
    - echo "üì¶ Archiving build artifacts..."
    # Ïª§Î∞ã Ï†ïÎ≥¥ Ï∂îÏ∂ú
    - export COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
    - export COMMIT_EMAIL=$(git log -1 --pretty=format:'%ae')
    - export COMMIT_DATE=$(git log -1 --pretty=format:'%ci')
    - export COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
    - export COMMIT_HASH=$(git rev-parse --short HEAD)
    
    # HTML Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
    - mkdir -p $ARTIFACT_BASE_PATH/$CI_COMMIT_REF_NAME
    - |
      cat > $ARTIFACT_BASE_PATH/$CI_COMMIT_REF_NAME/build-${CI_PIPELINE_ID}.html << EOF
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Build Report - ${CI_COMMIT_REF_NAME} - ${COMMIT_HASH}</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; background: #f5f5f5; }
          .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
          h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
          .info { background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 20px 0; }
          .info-row { display: flex; margin: 10px 0; }
          .info-label { font-weight: bold; width: 150px; color: #7f8c8d; }
          .info-value { flex: 1; color: #2c3e50; }
          .commit-message { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }
          .apps-list { margin: 20px 0; }
          .app-item { background: #e8f5e9; padding: 10px; margin: 5px 0; border-radius: 4px; }
          .timestamp { color: #95a5a6; font-size: 0.9em; margin-top: 20px; text-align: right; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>üöÄ Build Report</h1>
          
          <div class="info">
            <div class="info-row">
              <span class="info-label">Branch:</span>
              <span class="info-value">${CI_COMMIT_REF_NAME}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Commit Hash:</span>
              <span class="info-value">${COMMIT_HASH}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Author:</span>
              <span class="info-value">${COMMIT_AUTHOR} &lt;${COMMIT_EMAIL}&gt;</span>
            </div>
            <div class="info-row">
              <span class="info-label">Date:</span>
              <span class="info-value">${COMMIT_DATE}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Pipeline ID:</span>
              <span class="info-value">${CI_PIPELINE_ID}</span>
            </div>
          </div>
          
          <div class="commit-message">
            <strong>Commit Message:</strong><br>
            ${COMMIT_MESSAGE}
          </div>
          
          <h2>Built Applications</h2>
          <div class="apps-list">
      EOF
    
    # ÎπåÎìúÎêú Ïï± Î™©Î°ù Ï∂îÍ∞Ä
    - |
      for app in apps/*/; do
        app_name=$(basename "$app")
        echo "<div class=\"app-item\">‚úÖ $app_name</div>" >> $ARTIFACT_BASE_PATH/$CI_COMMIT_REF_NAME/build-${CI_PIPELINE_ID}.html
      done
    
    - |
      cat >> $ARTIFACT_BASE_PATH/$CI_COMMIT_REF_NAME/build-${CI_PIPELINE_ID}.html << EOF
          </div>
          
          <div class="timestamp">
            Generated: $(date)
          </div>
        </div>
      </body>
      </html>
      EOF
    
    - echo "‚úÖ Build report generated"
    
    # Google Drive ÎòêÎäî OneDrive ÏóÖÎ°úÎìú (rclone ÏÇ¨Ïö©)
    # ÏÇ¨Ï†ÑÏóê rclone configÎ•º GitLab CI/CD VariablesÏóê Ï†ÄÏû• ÌïÑÏöî
    - |
      if [ -n "$RCLONE_CONFIG" ]; then
        echo "‚òÅÔ∏è Uploading to cloud storage..."
        echo "$RCLONE_CONFIG" > ~/.rclone.conf
        apk add --no-cache rclone
        rclone copy $ARTIFACT_BASE_PATH remote:build-artifacts/ -v
        echo "‚úÖ Uploaded to cloud storage"
      else
        echo "‚ö†Ô∏è RCLONE_CONFIG not set, skipping cloud upload"
      fi
  artifacts:
    paths:
      - $ARTIFACT_BASE_PATH/
    expire_in: 90 days
  only:
    - main
    - develop
    - merge_requests

# =====================================
# ÏÑ†ÌÉù: Ï£ºÍ∏∞Ï†ÅÏù∏ Ï∫êÏãú Ï†ïÎ¶¨
# =====================================
cleanup_cache:
  stage: prepare
  image: alpine:latest
  script:
    - echo "üßπ Cleaning up old caches..."
    - find . -name "node_modules" -type d -mtime +7 -exec rm -rf {} +
    - find .turbo -type f -mtime +7 -delete
  only:
    - schedules
  when: manual
