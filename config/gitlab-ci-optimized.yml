# GitLab CI/CD Pipeline - Optimized Version
# ÏµúÏ†ÅÌôî: Î≥ëÎ†¨ Ïã§Ìñâ Í∞ïÌôî + Ï°∞Í±¥Î∂Ä ÎπåÎìú + Í∞ÑÏÜåÌôîÎêú ÏïÑÏπ¥Ïù¥Îπô

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  NODE_VERSION: "20"
  TURBO_TOKEN: $TURBO_TOKEN
  TURBO_TEAM: $TURBO_TEAM
  DEV_SERVER_HOST: $DEV_SERVER_HOST
  DEV_SERVER_USER: $DEV_SERVER_USER

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .turbo/
    - apps/*/node_modules/
    - packages/*/node_modules/

stages:
  - prepare
  - validate
  - build
  - deploy      # packageÏôÄ archiveÎ•º deploy ÏïàÏúºÎ°ú ÌÜµÌï©
  - notify      # ÏïåÎ¶º Ï∂îÍ∞Ä

# =====================================
# Stage 1: Ï§ÄÎπÑ
# =====================================
install_dependencies:
  stage: prepare
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üì¶ Installing dependencies..."
    - npm ci --prefer-offline --no-audit
  artifacts:
    paths:
      - node_modules/
      - apps/*/node_modules/
      - packages/*/node_modules/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# =====================================
# Stage 2: Í≤ÄÏ¶ù (Î≥ëÎ†¨ Ïã§Ìñâ)
# =====================================
lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - npx turbo run lint
  only:
    - merge_requests
    - main
    - develop

type_check:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - npx turbo run type-check
  only:
    - merge_requests
    - main
    - develop

test:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies"]
  script:
    - npx turbo run test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

# =====================================
# Stage 3: ÎπåÎìú (Ï°∞Í±¥Î∂Ä Ïã§Ìñâ Í∞ïÌôî)
# =====================================
build_changed:
  stage: build
  image: node:${NODE_VERSION}-alpine
  needs: ["install_dependencies", "lint", "type_check", "test"]
  script:
    - echo "üèóÔ∏è Building changed apps..."
    # TurborepoÍ∞Ä Î≥ÄÍ≤ΩÎêú Ïï±Îßå ÏûêÎèô Í∞êÏßÄÌïòÏó¨ ÎπåÎìú
    - npx turbo run build --filter='[HEAD^1]'
  artifacts:
    paths:
      - apps/*/dist/
    expire_in: 1 day
  only:
    - main
    - develop

# =====================================
# Stage 4: Î∞∞Ìè¨ (Î≥ëÎ†¨ Ïã§Ìñâ Í∞ïÌôî)
# =====================================
# 4-1. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
docker_build:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  needs: ["build_changed"]
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "üê≥ Building Docker images..."
    - |
      # Î≥ÄÍ≤ΩÎêú Ïï±Îßå Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú (dist Ìè¥Îçî Ï°¥Ïû¨ ÌôïÏù∏)
      for app in apps/*/; do
        app_name=$(basename "$app")
        if [ -d "$app/dist" ]; then
          echo "Building $app_name..."
          docker build \
            --build-arg APP_NAME=$app_name \
            --cache-from $CI_REGISTRY_IMAGE/$app_name:latest \
            --tag $CI_REGISTRY_IMAGE/$app_name:$CI_COMMIT_SHA \
            --tag $CI_REGISTRY_IMAGE/$app_name:latest \
            --file docker/Dockerfile.app \
            . && \
          docker push $CI_REGISTRY_IMAGE/$app_name:$CI_COMMIT_SHA && \
          docker push $CI_REGISTRY_IMAGE/$app_name:latest
        else
          echo "Skipping $app_name (not built)"
        fi
      done
  only:
    - main
    - develop

# 4-2. ÏÑúÎ≤Ñ Î∞∞Ìè¨
deploy_to_dev:
  stage: deploy
  image: alpine:latest
  needs: ["docker_build"]
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEV_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << 'ENDSSH'
        cd /opt/my-monorepo
        docker compose pull
        docker compose up -d --remove-orphans
        docker image prune -af --filter "until=24h"
      ENDSSH
  environment:
    name: development
    url: https://dev.yourcompany.com
  only:
    - develop

# 4-3. ÏïÑÏπ¥Ïù¥Îπô (Î≥ëÎ†¨ Ïã§Ìñâ)
archive_build:
  stage: deploy
  image: alpine:latest
  needs: ["build_changed"]
  before_script:
    - apk add --no-cache git curl
  script:
    - mkdir -p build-artifacts/$CI_COMMIT_REF_NAME
    - |
      # Ïª§Î∞ã Ï†ïÎ≥¥ ÌÖçÏä§Ìä∏ ÌååÏùº ÏÉùÏÑ±
      cat > build-artifacts/$CI_COMMIT_REF_NAME/commit-${CI_PIPELINE_ID}.txt << EOF
      ===============================================
      Build Artifact - Pipeline #${CI_PIPELINE_ID}
      ===============================================
      
      Î∏åÎûúÏπò: ${CI_COMMIT_REF_NAME}
      Ïª§Î∞ã SHA: ${CI_COMMIT_SHA}
      Ïª§Î∞ã ÏûëÏÑ±Ïûê: $(git log -1 --pretty=format:'%an <%ae>')
      Ïª§Î∞ã ÎÇ†Ïßú: $(git log -1 --pretty=format:'%ci')
      Ïª§Î∞ã Î©îÏãúÏßÄ: $(git log -1 --pretty=format:'%s')
      
      ===============================================
      GitLab Ïª§Î∞ã ÌéòÏù¥ÏßÄ
      ===============================================
      ${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}
      
      ÏàòÎèô Ï†ÄÏû•: Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Ïó¥Í≥† "Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•"
      
      ===============================================
      ÎπåÎìúÎêú Ïï± Î™©Î°ù
      ===============================================
      EOF
    - |
      for app in apps/*/; do
        if [ -d "$app/dist" ]; then
          echo "- $(basename $app)" >> build-artifacts/$CI_COMMIT_REF_NAME/commit-${CI_PIPELINE_ID}.txt
        fi
      done
    - |
      # GITLAB_TOKENÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèô HTML Îã§Ïö¥Î°úÎìú (ÏÑ†ÌÉù)
      if [ -n "$GITLAB_TOKEN" ]; then
        COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y%m%d-%H%M' ${CI_COMMIT_SHA})
        COMMIT_MSG=$(git log -1 --format=%s ${CI_COMMIT_SHA} | sed 's/[^a-zA-Z0-9Í∞Ä-Ìû£]/-/g' | cut -c1-50)
        COMMIT_SHORT=$(echo ${CI_COMMIT_SHA} | cut -c1-8)
        FILENAME="${COMMIT_DATE}-${COMMIT_MSG}-${COMMIT_SHORT}.html"
        
        wget --header="PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
             --timeout=30 --tries=3 \
             -O "build-artifacts/$CI_COMMIT_REF_NAME/${FILENAME}" \
             "${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA}" \
             && echo "‚úÖ HTML saved: ${FILENAME}" \
             || echo "‚ÑπÔ∏è HTML download skipped (manual download available)"
      fi
    - |
      # ÌÅ¥ÎùºÏö∞Îìú ÏóÖÎ°úÎìú (ÏÑ†ÌÉù)
      if [ -n "$RCLONE_CONFIG" ]; then
        echo "$RCLONE_CONFIG" > ~/.rclone.conf
        apk add --no-cache rclone
        rclone copy build-artifacts/ remote:build-artifacts/ -v || true
      fi
  artifacts:
    paths:
      - build-artifacts/
    expire_in: 90 days
  only:
    - main
    - develop
    - merge_requests

# =====================================
# Stage 5: ÏïåÎ¶º (ÏÉàÎ°ú Ï∂îÍ∞Ä)
# =====================================
notify_success:
  stage: notify
  image: alpine:latest
  needs: ["deploy_to_dev"]
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        apk add --no-cache curl
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ: '"$CI_COMMIT_MESSAGE"'",
            "attachments": [{
              "color": "good",
              "fields": [
                {"title": "Î∏åÎûúÏπò", "value": "'"$CI_COMMIT_REF_NAME"'", "short": true},
                {"title": "Ïª§Î∞ã", "value": "'"${CI_COMMIT_SHA:0:8}"'", "short": true},
                {"title": "ÏûëÏÑ±Ïûê", "value": "'"$GITLAB_USER_NAME"'", "short": true},
                {"title": "ÌååÏù¥ÌîÑÎùºÏù∏", "value": "<'"$CI_PIPELINE_URL"'|#'"$CI_PIPELINE_ID"'>", "short": true}
              ]
            }]
          }'
      fi
  when: on_success
  only:
    - develop
    - main

notify_failure:
  stage: notify
  image: alpine:latest
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        apk add --no-cache curl
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚ùå Î∞∞Ìè¨ Ïã§Ìå®: '"$CI_COMMIT_MESSAGE"'",
            "attachments": [{
              "color": "danger",
              "fields": [
                {"title": "Î∏åÎûúÏπò", "value": "'"$CI_COMMIT_REF_NAME"'", "short": true},
                {"title": "Ïã§Ìå® Job", "value": "'"$CI_JOB_NAME"'", "short": true},
                {"title": "ÌååÏù¥ÌîÑÎùºÏù∏", "value": "<'"$CI_PIPELINE_URL"'|#'"$CI_PIPELINE_ID"'>", "short": false}
              ]
            }]
          }'
      fi
  when: on_failure
  only:
    - develop
    - main
